<!DOCTYPE html>

<html>
  <head>
    <title>MediaCapture</title>
  </head>

  <body>
    <!-- 사진 촬영 & 업로드 -->
    <form action="/upload" method="post" enctype="multipart/form-data">
      <input
        type="file"
        name="camera_image"
        accept="image/*"
        capture="user"
        required
      />
      <input type="submit" value="업로드" />
    </form>

    <!-- 사진 미리보기 -->
    <canvas id="thumbnail"></canvas>

    <canvas id="original"></canvas>

    <script>
      let input = document.querySelector("input[type=file]");
      input.onchange = () => {
        let file = input.files[0];
        drawThumbnail(file);
        drawOriginal(file);
      };

      function drawThumbnail(file) {
        let reader = new FileReader();
        reader.onload = (e) => {
          let dataURL = e.target.result;
          let canvas = document.getElementById("thumbnail");
          let ctx = canvas.getContext("2d");
          let img = new Image();

          img.onload = () => {
            const MAX_WIDTH = 400;
            const MAX_HEIGHT = 400;
            let width = img.width;
            let height = img.height;

            if (width > height) {
              if (width > MAX_WIDTH) {
                height *= MAX_WIDTH / width;
                width = MAX_WIDTH;
              }
            } else {
              if (height > MAX_HEIGHT) {
                width *= MAX_HEIGHT / height;
                height = MAX_HEIGHT;
              }
            }
            canvas.width = width;
            canvas.height = height;
            ctx.drawImage(img, 0, 0, width, height);
          };
          img.src = dataURL;
        };
        reader.readAsDataURL(file);
      }

      function drawOriginal(file) {
        let reader = new FileReader();
        reader.onload = (e) => {
          let dataURL = e.target.result;
          let canvas = document.getElementById("original");
          let ctx = canvas.getContext("2d");
          let img = new Image();

          img.onload = () => {
            canvas.width = img.width;
            canvas.height = img.height;
            ctx.drawImage(img, 0, 0);
          };
          img.src = dataURL;
        };
        reader.readAsDataURL(file);
      }
    </script>
  </body>
</html>
